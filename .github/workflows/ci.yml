name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-mock

    - name: Run contract tests
      run: |
        pytest tests/test_consultant_contract.py tests/test_identity_contract.py tests/test_internal_state_contract.py tests/test_wake_contract.py -v

    - name: Verify test count
      run: |
        # Verify we have exactly 61 contract tests (updated v2.10.0)
        TEST_COUNT=$(pytest tests/test_consultant_contract.py tests/test_identity_contract.py tests/test_internal_state_contract.py tests/test_wake_contract.py --collect-only -q | tail -1 | awk '{print $1}')
        if [ "$TEST_COUNT" != "61" ]; then
          echo "ERROR: Expected 61 contract tests, found $TEST_COUNT"
          exit 1
        fi
        echo "✓ Contract test count validated: 61 tests"

  privacy-validation:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Check for private instance references
      run: |
        echo "Checking for private instance references..."

        # Check public-facing files for privacy violations
        VIOLATIONS=0

        # Check for private instance names
        if grep -ri "legalon\|healthcare.*consultant\|insurance.*consultant\|private-contracts\|private-it" \
          README.md AGENTS.md .aget/version.json docs/CAPABILITIES.md docs/COMPARISON_MATRIX.md docs/USAGE_GUIDE.md 2>/dev/null; then
          echo "ERROR: Found private instance references in public files"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi

        # Check for personal identifiers
        if grep -ri "Gabor\|aget-framework" \
          README.md AGENTS.md .aget/version.json docs/CAPABILITIES.md docs/COMPARISON_MATRIX.md docs/USAGE_GUIDE.md 2>/dev/null; then
          echo "ERROR: Found personal identifiers in public files"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi

        # Check tests for private references
        if grep -r "legalon\|private-contracts\|private-it\|private-healthcare\|private-insurance" tests/*.py 2>/dev/null; then
          echo "ERROR: Found private references in test files"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi

        if [ $VIOLATIONS -gt 0 ]; then
          echo "❌ Privacy validation failed: $VIOLATIONS violation(s) found"
          exit 1
        fi

        echo "✅ Privacy validation passed: No violations found"

  template-validation:
    runs-on: ubuntu-latest
    needs: [contract-tests, privacy-validation]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Validate template structure
      run: |
        echo "Validating template structure..."

        # Check required files exist
        required_files=(
          ".aget/version.json"
          "AGENTS.md"
          "CLAUDE.md"
          "README.md"
          "LICENSE"
          "docs/CAPABILITIES.md"
          "docs/COMPARISON_MATRIX.md"
          "docs/USAGE_GUIDE.md"
          ".aget/analysis/.gitkeep"
          ".aget/evidence/.gitkeep"
        )

        for file in "${required_files[@]}"; do
          if [ ! -e "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
        done

        echo "✓ All required files present"

    - name: Validate version.json
      run: |
        python -m pip install --upgrade pip

        # Validate JSON syntax
        python -c "import json; json.load(open('.aget/version.json'))"

        # Validate template field (v3.0: template replaces persona in version.json)
        TEMPLATE=$(python -c "import json; print(json.load(open('.aget/version.json'))['template'])")
        if [ "$TEMPLATE" != "consultant" ]; then
          echo "ERROR: template field must be 'consultant', got '$TEMPLATE'"
          exit 1
        fi

        # v3.0: persona is now in .aget/persona/ directory, not version.json
        # Skip v2.x persona field check

        echo "✓ version.json validated"

    - name: Validate CLAUDE.md symlink
      run: |
        if [ ! -L "CLAUDE.md" ]; then
          echo "ERROR: CLAUDE.md must be a symlink to AGENTS.md"
          exit 1
        fi

        TARGET=$(readlink CLAUDE.md)
        if [ "$TARGET" != "AGENTS.md" ]; then
          echo "ERROR: CLAUDE.md must link to AGENTS.md, got '$TARGET'"
          exit 1
        fi

        echo "✓ CLAUDE.md symlink validated"

  all-checks-passed:
    runs-on: ubuntu-latest
    needs: [contract-tests, privacy-validation, template-validation]

    steps:
    - name: All checks passed
      run: |
        echo "✅ All CI checks passed!"
        echo "   - Contract tests: 61/61 passing"
        echo "   - Privacy validation: Clean"
        echo "   - Template validation: Valid"
